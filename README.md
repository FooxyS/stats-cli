# stats-cli

это консольный инструмент для статистической агрегации данных и профилирования, поддерживающий как Java, так и Go агрегаторы. Разработан для высокопроизводительной обработки JSON-данных, обладает расширяемой архитектурой и поддержкой профилирования JVM.

## Чем примечателен stats-cli

В отличие от простых CLI-агрегаторов, `stats-cli` оптимизирован под работу с огромными объёмами данных без критических нагрузок на память JVM.

- **Уникальные значения (distinct count) на больших данных**
  - Java-часть считывает уникальные строки.
  - Каждое значение хэшируется быстрым алгоритмом **xxHash**.
  - Хэши сохраняются в **off-heap память** (минуя GC и heap).
  - При заполнении off-heap данные сбрасываются (*flush*) в Go-агрегатор.
  - Go-часть добавляет их в **HyperLogLog (HLL)**, обеспечивая приближённый, но крайне эффективный по памяти подсчёт уникальных значений.

Такой гибридный подход позволяет обрабатывать массивы данных, которые не помещаются в оперативную память JVM, сохраняя высокую скорость и низкие накладные расходы.


## Возможности
- Агрегация JSON-данных с использованием различных стратегий (AVG, MAX, DC, etc.)
- Подключаемые агрегаторы (Java и Go native)
- Профилирование JVM и отчёты о производительности
- Настройка через properties и JSON-файлы
- CLI-интерфейс для интеграции и автоматизации


## Структура проекта

```
├── bin/                # Нативные библиотеки и JNI-шимы
├── data/               # Пользовательский файлы для агрегации
├── go_native/          # Исходный код Go-агрегаторов
├── reports/            # Профили и тестовые отчёты
├── results/            # Выходные данные (например, output.json)
├── src/
│   ├── main/java/      # Основной Java-код
│   ├── resources/      # Конфигурация приложения
│   └── test/java/      # Юнит- и интеграционные тесты
├── pom.xml             # Maven build-файл
└── README.md           # Документация проекта
```

## Установка

### Требования
- Java 17 или выше
- Maven 3.6+
- Go (для пересборки Go-агрегаторов, если требуется)

### Сборка

Клонируйте репозиторий, перейдите в корень проекта и соберите проект с помощью Maven:

```sh
git clone https://github.com/FooxyS/stats-cli.git
mvn clean package
```

В результате будет собран исполняемый Fat-JAR и скомпилирован весь Java-код. Нативные библиотеки должны находиться в папке `bin/`.

## Использование

Запуск CLI-инструмента:

```sh
java -jar target/stats-cli-1.0.jar [опции]
```

### Пример

Вы можете посмотреть на работу программы через тестовые данные в data/. Введите комамнду:

```sh
java -jar target/stats-cli-1.0.jar -a DC -f number -d testData.json
```
Или с группировкой по полям name,status: 

```sh
java -jar target/stats-cli-1.0.jar -a DC -f number -g name,status -d testData.json
```

#### Опции CLI
- `-a <агрегация>`: Тип агрегации (например, avg, max, dc)
- `-f <поле>`: Имя json-поля для агрегации.
- `-g <поле, ...>`: Имена json-полей для группировки. Формат перечисления полей смотреть в примере выше.
- `-d <файл>`: Путь к входному JSON-файлу. Поддерживается ввод имени, относительный путь с data/ или абсолютный путь к файлу.

## Конфигурация

Изменяйте `src/resources/application.properties` для настройки параметров по умолчанию. 

Поддерживается настройка параметров:
- `BATCH_SIZE` - используется для указания количества элементов в 1 батче.
- `USE_NATIVE` - нужен, чтобы использовать нативные библиотеки.

## Расширение

Чтобы добавить новые агрегаторы или парсеры, реализуйте соответствующие интерфейсы в `src/main/java/com/volgoblob/internal/domain/interfaces/` и зарегистрируйте их в нужном реестре.

## Тестирование

Запуск всех тестов:

```sh
mvn test
```
